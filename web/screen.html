<script
  type="text/javascript"
  src="https://www.airconsole.com/api/airconsole-1.8.0.js"
></script>

<link rel="stylesheet" href="/css/css.css" />
<link rel="stylesheet" href="/css/screen.css" />

<!DOCTYPE html>
<script src="build/wasm_exec.js"></script>
<script>
// Polyfill
if (!WebAssembly.instantiateStreaming) {
    WebAssembly.instantiateStreaming = async (resp, importObject) => {
        const source = await (await resp).arrayBuffer();
        return await WebAssembly.instantiate(source, importObject);
    };
}

// Create a new instance of the Go WASM loader to load the game
const go = new Go();
WebAssembly.instantiateStreaming(fetch("build/game.wasm"), go.importObject).then(result => {
    go.run(result.instance);
});
</script>

<script type="text/javascript">
  // Set up some config 
  const minPlayers = 1;
  const maxPlayers = 2;

  // Set up some variables for state
  let airconsole;
  let activePlayers = [];
  let paused = false;
  let initialized = false;

  // This should be callable from the Go code
  function changeControllerScreen(screen) {
    // Update the state of the controller screen
    if(!airconsole) {
      console.error("AirConsole not initialized");
      return;
    }
    airconsole.setCustomDeviceStateProperty("screen", screen);
  }

  setupAirConsole();
  function setupAirConsole() {
    airconsole = new AirConsole({ silence_inactive_players: true });

    // Listen for pause and resume events
    airconsole.onPause = function () {
      paused = true;
      // Send pause event to the game via the JS/GO binding
      passPauseToGame();
    };
    airconsole.onResume = function () {
      paused = false;
      // Send resume event to the game via the JS/GO binding
      passResumeToGame();
    };
    
    // Listen for device connect and disconnect events
    airconsole.onConnect = function (deviceId) {
      // Here we can do any logic we want when a new device connects, such as checking that enough players have joined.
      if(!initialized) {
        // Do any actions that should only be done once here (on first device connect)
        initialized = true;
      }

      handlePlayers(); // This will set the number of active players, limited to the maxPlayers amount
    };
    airconsole.onDisconnect = function (deviceId) {
      // Here we can do any logic we want when a device disconnects, such as checking if the game should end.
      handlePlayers();
    };

    // Listen for messages from other devices
    airconsole.onMessage = function (from, data) {
      let playerId = airconsole.convertDeviceIdToPlayerNumber(from);
      // Check if device is an active player
      if(!activePlayers.includes(from)) {
        console.log("Device is not an active player");
        return;
      }

      // Send our custom input events received from the controllers to the game
      if(data.type === "input") {
        // Pass the action to the game via the JS/GO binding
        passInputToGame(playerId, data.input, data.direction);

        console.log("Player: " + (playerId + 1) + " Action received: " + data.action + " Direction: " + data.direction);
        airconsole.message(from, "Action received!");
      }
    };
  }

  // Function to handle the number of players connected
  // Limits the number of active players to the maxPlayers amount
  // Sets the activePlayers array to the active player device IDs
  function handlePlayers() {
    var connectedControllers = airconsole.getControllerDeviceIds();

    let validPlayersCount = connectedControllers.length > maxPlayers
            ? maxPlayers
            : airconsole.getControllerDeviceIds().length;

    airconsole.setActivePlayers(validPlayersCount);

    activePlayers = airconsole.getActivePlayerDeviceIds();
  }

  // Function to get player details from a device ID
  function getPlayerDetails(deviceId) {
    let player = airconsole.convertDeviceIdToPlayerNumber(deviceId);
    let name = airconsole.getNickname(deviceId);
    let profilePicture = airconsole.getProfilePicture(deviceId);
    let customData = airconsole.getCustomDeviceState(deviceId);
    let active = airconsole.getActivePlayerDeviceIds().includes(deviceId);

    return {
      player: player,
      name: name,
      profilePicture: profilePicture,
      customData: customData,
      active: active,
    };
  }
</script>
